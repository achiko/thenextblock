<!doctype html>
<html>
	<head>
	  <meta http-equiv="cache-control" content="max-age=0" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
    <meta http-equiv="pragma" content="no-cache" />
		<title>TheNextBlock</title>
		<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/css/bootstrap.min.css" integrity="sha384-PsH8R72JQ3SOdhVi3uxftmaW6Vc51MKb0q5P2rRUpPvrszuE4W1povHYgTpBfshb" crossorigin="anonymous">
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/alertifyjs@1.11.0/build/css/alertify.min.css"/>
		<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/alertifyjs@1.11.0/build/css/themes/default.min.css"/>
	  <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" type="text/css" />
	  <style>
	    .pointer {
	      cursor: pointer;
	    }
	    .text-center {
	      text-align: center;
	    }
	    .lindicator {
	      border-bottom: 2px solid #2962FF;
	      width: 0%;
	      opacity: 0.5;
	      margin-bottom: 10px;
	    }
	  </style>
	</head>
	<body>
	    <div id="app">
	        <nav class="navbar navbar-expand-lg navbar-light bg-light">
    		  <a class="navbar-brand" href="#">TheNextBlock</a>
    		  <button class="navbar-toggler" type="button" data-toggle="collapse" data-target="#navbarSupportedContent" aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
    			<span class="navbar-toggler-icon"></span>
    		  </button>
    
    		  <div class="collapse navbar-collapse" id="navbarSupportedContent">
    			<ul class="navbar-nav mr-auto">
    			  <li class="nav-item">
    				<a class="nav-link" target="_blank" href="https://github.com/achiko/thenextblock"><i class="fa fa-github" aria-hidden="true"></i></a>
    			  </li>
    			  <li>
              <a v-if="metamask.lastBlockNumber" class="nav-link" target="_blank" v-bind:href="getEtherScanBlockLink(metamask.lastBlockNumber)"><span>Last Updated Block: <strong>{{metamask.lastBlockNumber}}</strong></span></a>
    			  </li>
    			  <li>
              <select class="form-control" style="width: 80px; margin: 0 auto;" v-model="loadingInterval" v-on:change="animateLoading" data-toggle="tooltip" data-placement="right" title="Miner Refresh Interval In Seconds">
                <option v-for="io in loadingIntervalOptions">{{io}}</option>
              </select>
    			  </li>
    			  <!--<li class="nav-item dropdown">
    				<a class="nav-link dropdown-toggle" href="#" id="navbarDropdown" role="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
    				  Dropdown
    				</a>
    				<div class="dropdown-menu" aria-labelledby="navbarDropdown">
    				  <a class="dropdown-item" href="#">Action</a>
    				  <a class="dropdown-item" href="#">Another action</a>
    				  <div class="dropdown-divider"></div>
    				  <a class="dropdown-item" href="#">Something else here</a>
    				</div>
    			  </li>-->
    			</ul>
    			<div id="account" v-if="metamask.address.length">
    			    <span>Addr: <a target="_blank" v-bind:href="getEtherScanAddressLink(metamask.address)">{{metamask.address}}</a></span>
    			    <span class="badge badge-pill badge-primary">{{metamask.balance}} ETH</span>
    			    <span class="badge badge-success">Metamask</span>
    		    </div>
    		  </div>
    		</nav>
    		<div class="lindicator" id="loading-indicator"></div>
    		<div class="container-fluid">
    		  <div class="row">
    		    <div style="min-width: 610px;" class="col-md-6">
    		      <table v-if="metamask.address.length" class="table">
                <thead>
                  <tr class="text-center">
                    <td># Rank</td>
                    <td>Mined Blocks</td>
                    <td>Miner</td>
                    <td>
                      <select class="form-control" style="width: 80px; margin: 0 auto;" v-model="blockCount" v-on:change="loadMiners()" data-toggle="tooltip" data-placement="top" title="Last Blocks">
                        <option v-for="bo in blockCountOptions">{{bo}}</option>
                      </select>
                    </td>
                  </tr>
                </thead>
                <tbody>
                  <tr class="text-center" v-for="(miner, index) in sortedMiners">
                    <td>{{index+1}}</td>
                    <td>{{miner.blocks.length}}   ({{formatFloat((miner.blocks.length * 100)/blockCount, 2)}}%)</td>
                    <td>
                      <a target="_blank" v-bind:href="getEtherScanAddressLink(miner.address+'#mine')" data-toggle="tooltip" data-placement="top" title="Link To Etherscan">{{miner.address}}</a>
                      <span v-if="miner.name.length" class="badge badge-primary" data-toggle="tooltip" data-placement="top" title="Mining Pool Name"><strong>{{miner.name}}</strong></span>
                      <span class="badge badge-success" data-toggle="tooltip" data-placement="top" title="Miners Ballance"><strong>{{miner.balance}} ETH</strong></span>
                    </td>
                    <td><button v-on:click="placeBet(miner.address)" type="button" class="btn btn-success btn-sm pointer" data-toggle="tooltip" data-placement="right" title="Bet On This Miner">BET</button></td>
                  </tr>
                </tbody>
              </table>
    		    </div>
    		    <div style="min-width: 610px;" class="col-md-6">
              <div class="row">
                <div class="col-md-4">
                  Balance: {{player.balance}}
                </div>
                <div class="col-md-4">
                  Guess Count: {{player.guessCount}}
                </div>
                <div class="col-md-4">
                  Jackpot: {{player.pot}}
                </div>
              </div>
    		    </div>
    		  </div>
    		</div>
	    </div>
		<script
		  src="https://code.jquery.com/jquery-3.2.1.min.js"
		  integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="
		  crossorigin="anonymous"></script>
		<script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.12.3/umd/popper.min.js" integrity="sha384-vFJXuSJphROIrBnz7yo7oB41mKfc8JzQZiCq4NCceLEaO4IHwicKwpJf9c9IpFgh" crossorigin="anonymous"></script>
		<script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0-beta.2/js/bootstrap.min.js" integrity="sha384-alpBpkh1PFOepccYVYDB4do5UnbKysX5WZXm3XxPqe5iKTfUKjNkCk9SaVuEZflJ" crossorigin="anonymous"></script>
		<script src="https://cdn.jsdelivr.net/npm/alertifyjs@1.11.0/build/alertify.min.js"></script>
		<script src="https://cdn.jsdelivr.net/npm/vue@2.5.13/dist/vue.js"></script>
		<script type="text/javascript" src="https://cdn.jsdelivr.net/npm/ethjs@0.3.0/dist/ethjs.min.js"></script>
    <script type="text/javascript" src="web3.min.js"></script>
		<script type"text/javascript">
    		/* global web3 */
    		/* global Web3 */
    		/* global Vue */
    		/* global alertify */
    		/* global $ */
    		/* global Eth */
    		var app;
    		$( document ).ready(function() {
          app = new Vue({
            el: '#app',
            data: {
                contract: {
                  addr: "0x6712F7e812499bfae13378eCfA7D27871AD406D2"
                },
                metamask: {
                    address: "",
                    balance: 0,
                    lastBlockNumber: 0
                },
                miners: [],
                minerNames: {
                  "0xea674fdde714fd979de3edf0f56aa9716b898ec8": "Ethermine",
                  "0x829bd824b016326a401d083b33d092293333a830": "f2pool_2",
                  "0x5a0b54d5dc17e0aadc383d2db43b0a0d3e029c4c": "ethfans.org_2",
                  "0xb2930b35844a230f00e51431acae96fe543a0347": "miningpoolhub_1",
                  "0x2a65aca4d5fc5b5c859090a6c34d164135398226": "DwarfPool1",
                  "0xf3b9d2c81f2b24b0fa0acaaa865b7d9ced5fc2fb": "bitclubpool",
                  "0x4bb96091ee9d802ed039c4d1a5f6216f90f81b01": "Ethpool_2",
                  "0x6a7a43be33ba930fe58f34e07d0ad6ba7adb9b1f": "Coinotron_2",
                  "0x9435d50503aee35c8757ae4933f7a0ab56597805": "waterhole"
                },
                blockCount: 0,
                blockCountOptions: [],
                loadingInterval: null,
                loadingIntervalOptions: [],
                player: {
                  balance: 0,
                  guessCount: 0,
                  pot: 0
                }
            },
            computed: {
              sortedMiners: function () {
                var _this = this;
                return _this.miners.sort(function(a, b) {
                  if (a.blocks.length < b.blocks.length) {
                    return 1;
                  }
                  if (a.blocks.length > b.blocks.length) {
                    return -1;
                  }
                  return 0;
                });
              }
            },
            methods: {
              hasWeb3: function () {
                return typeof web3 !== 'undefined' && web3.currentProvider;
              },
              hasMetamask: function() {
                return web3.currentProvider.isMetaMask && web3.currentProvider.isConnected();
              },
              isMetaMaskLocked: function() {
    			      return !this.metamask.web3.eth.accounts.length;
              },
              addMiner: function(err, block) {
                var _this = this;
                if(!err && block) {
                  var miner = _this.miners.find(function(miner){ return miner.address == block.miner });
                  if(miner) {
                    miner.blocks.push(block.number);
                  } else {
                    var index = _this.miners.push({
                      blocks: [block.number],
                      address: block.miner,
                      name: _this.minerNames[block.miner] || "",
                      balance: 0
                    }) - 1;
                    miner = _this.miners[index];
                    _this.metamask.web3.eth.getBalance(block.miner, function(err, value) {
                      if(!err)
                      miner.balance = _this.formatFloat(_this.metamask.web3.fromWei(value, 'ether').toFixed());
                    });
                  }
                }
              },
              loadMiners: function(bc) {
                var _this = this;
                _this.miners = [];
                bc = bc || _this.blockCount;
                _this.metamask.web3.eth.getBlockNumber(function(err, value) {
                  if(err) return;
                  _this.metamask.lastBlockNumber = value;
                  for(var i = 0; i < bc; i++)
                    _this.metamask.web3.eth.getBlock(value - i, _this.addMiner);
                });
              },
              loadAccount: function() {
                var _this = this;
                _this.metamask.web3.eth.getAccounts(function(err, accounts){
                  if(err) return;
                    _this.metamask.address = accounts[0];
                    _this.metamask.web3.eth.getBalance(_this.metamask.address, function(err, balance) {
                      if(!err)
                        _this.metamask.balance = _this.formatFloat(_this.metamask.web3.fromWei(balance, 'ether').toFixed());
                    });
                });
              },
              loadBlockCountOptions: function(factor, rep) {
                var _this = this;
                _this.blockCountOptions = [];
                for(var i = 1; i <= rep; i++)
                  _this.blockCountOptions.push(i*factor);
                _this.blockCount = _this.blockCountOptions[0];
              },
              loadIntervalOptions: function(factor, rep) {
                var _this = this;
                _this.loadingIntervalOptions = [];
                for(var i = 1; i <= rep; i++)
                  _this.loadingIntervalOptions.push(i*factor);
                _this.loadingInterval = _this.loadingIntervalOptions[0];
              },
              loadContractData: function() {
                var _this = this;
                _this.contract.cls.getPot().then(function(val){ _this.player.pot = val[0].toString(); });
                _this.contract.cls.getMyBalance().then(function(val){ _this.player.balance = val[0].toString(); });
                
                _this.contract.cls.getMyGuessCount().then(function(val){ _this.player.guessCount = val[0].toString(); });

                _this.contract.cls.allowedBetAmount().then(function(val){ _this.player.allowedBetAmount = val[0].toString(); });
              },
              placeBet: function(miner) {
                console.log(miner);
                var _this = this;
                _this.contract.cls.placeBet(miner, { from: _this.metamask.web3.eth.accounts[0], value: _this.player.allowedBetAmount }).then(console.log);
              },
              formatFloat: function(number, factor) {
                //return parseFloat(Math.round(number * 100) / 100).toFixed(5);
                return parseFloat(number).toFixed(factor  || 5);
              },
              getEtherScanAddressLink: function(address) {
                return "https://etherscan.io/address/{{address}}".replace('{{address}}', address);
              },
              getEtherScanBlockLink: function(blockNumber) {
                return "https://etherscan.io/block/{{blockNumber}}".replace('{{blockNumber}}', blockNumber);
              },
              animateLoading: function() {
                var _this = this;
                $("#loading-indicator").css('width', '0%').css('opacity', '0.5').animate({ width: "100%", opacity: 1 }, _this.loadingInterval*1000, 'linear', _this.animateLoading);
                _this.loadMiners();
                _this.loadContractData();
              }
            },
            created: function() {
                var _this = this;
                if(!_this.metamask.web3){
                    _this.metamask.web3 = new Web3(web3.currentProvider);
                    _this.metamask.eth = new Eth(web3.currentProvider);
                }
                if(!_this.hasWeb3()) {
                    alertify.alert("Metamask Extension is not installed.", function() {
                    	alertify.error('Install Metamask Extension.');
                    });
                    return;
                }
                if(!_this.hasMetamask()) {
                    alertify.alert("Your metamask is not connected.", function() {
                    });
                    return;
                }
                if(_this.isMetaMaskLocked()) {
                    alertify.alert("Metamask is locked.", function() {
                    	alertify.error('Unlock metamask.');
                    });
                    return;
                }
                
                _this.contract.abi = [{
              		"constant": true,
              		"inputs": [],
              		"name": "getBalance",
              		"outputs": [
              			{
              				"name": "",
              				"type": "uint256"
              			}
              		],
              		"payable": false,
              		"stateMutability": "view",
              		"type": "function"
              	},
              	{
              		"constant": false,
              		"inputs": [
              			{
              				"name": "_miner",
              				"type": "address"
              			}
              		],
              		"name": "placeBet",
              		"outputs": [],
              		"payable": true,
              		"stateMutability": "payable",
              		"type": "function"
              	},
              	{
              		"constant": true,
              		"inputs": [],
              		"name": "isBetEnabled",
              		"outputs": [
              			{
              				"name": "",
              				"type": "bool"
              			}
              		],
              		"payable": false,
              		"stateMutability": "view",
              		"type": "function"
              	},
              	{
              		"constant": true,
              		"inputs": [],
              		"name": "getPot",
              		"outputs": [
              			{
              				"name": "",
              				"type": "uint256"
              			}
              		],
              		"payable": false,
              		"stateMutability": "view",
              		"type": "function"
              	},
              	{
              		"constant": false,
              		"inputs": [],
              		"name": "withdrawMyFunds",
              		"outputs": [],
              		"payable": false,
              		"stateMutability": "nonpayable",
              		"type": "function"
              	},
              	{
              		"constant": true,
              		"inputs": [],
              		"name": "getMyBalance",
              		"outputs": [
              			{
              				"name": "",
              				"type": "uint256"
              			}
              		],
              		"payable": false,
              		"stateMutability": "view",
              		"type": "function"
              	},
              	{
              		"constant": false,
              		"inputs": [],
              		"name": "withdrawOwnersFunds",
              		"outputs": [],
              		"payable": false,
              		"stateMutability": "nonpayable",
              		"type": "function"
              	},
              	{
              		"constant": true,
              		"inputs": [],
              		"name": "allowedBetAmount",
              		"outputs": [
              			{
              				"name": "",
              				"type": "uint256"
              			}
              		],
              		"payable": false,
              		"stateMutability": "view",
              		"type": "function"
              	},
              	{
              		"constant": true,
              		"inputs": [],
              		"name": "getMyGuessCount",
              		"outputs": [
              			{
              				"name": "",
              				"type": "uint8"
              			}
              		],
              		"payable": false,
              		"stateMutability": "view",
              		"type": "function"
              	},
              	{
              		"constant": true,
              		"inputs": [
              			{
              				"name": "playerAddr",
              				"type": "address"
              			}
              		],
              		"name": "getPlayersGuessCount",
              		"outputs": [
              			{
              				"name": "",
              				"type": "uint8"
              			}
              		],
              		"payable": false,
              		"stateMutability": "view",
              		"type": "function"
              	},
              	{
              		"constant": true,
              		"inputs": [
              			{
              				"name": "playerAddr",
              				"type": "address"
              			}
              		],
              		"name": "getPlayersWonBlocks",
              		"outputs": [
              			{
              				"name": "",
              				"type": "uint256[]"
              			}
              		],
              		"payable": false,
              		"stateMutability": "view",
              		"type": "function"
              	},
              	{
              		"constant": true,
              		"inputs": [],
              		"name": "requiredGuessCount",
              		"outputs": [
              			{
              				"name": "",
              				"type": "uint8"
              			}
              		],
              		"payable": false,
              		"stateMutability": "view",
              		"type": "function"
              	},
              	{
              		"constant": true,
              		"inputs": [],
              		"name": "jackpotPercent",
              		"outputs": [
              			{
              				"name": "",
              				"type": "uint8"
              			}
              		],
              		"payable": false,
              		"stateMutability": "view",
              		"type": "function"
              	},
              	{
              		"constant": true,
              		"inputs": [],
              		"name": "ownerProfitPercent",
              		"outputs": [
              			{
              				"name": "",
              				"type": "uint8"
              			}
              		],
              		"payable": false,
              		"stateMutability": "view",
              		"type": "function"
              	},
              	{
              		"constant": true,
              		"inputs": [
              			{
              				"name": "playerAddr",
              				"type": "address"
              			}
              		],
              		"name": "getPlayersBalance",
              		"outputs": [
              			{
              				"name": "",
              				"type": "uint256"
              			}
              		],
              		"payable": false,
              		"stateMutability": "view",
              		"type": "function"
              	},
              	{
              		"constant": true,
              		"inputs": [
              			{
              				"name": "playerAddr",
              				"type": "address"
              			}
              		],
              		"name": "getMyWonBlocks",
              		"outputs": [
              			{
              				"name": "",
              				"type": "uint256[]"
              			}
              		],
              		"payable": false,
              		"stateMutability": "view",
              		"type": "function"
              	},
              	{
              		"constant": true,
              		"inputs": [],
              		"name": "getOwnersBalance",
              		"outputs": [
              			{
              				"name": "",
              				"type": "uint256"
              			}
              		],
              		"payable": false,
              		"stateMutability": "view",
              		"type": "function"
              	},
              	{
              		"inputs": [],
              		"payable": false,
              		"stateMutability": "nonpayable",
              		"type": "constructor"
              	},
              	{
              		"payable": true,
              		"stateMutability": "payable",
              		"type": "fallback"
              	},
              	{
              		"anonymous": false,
              		"inputs": [
              			{
              				"indexed": false,
              				"name": "sender",
              				"type": "address"
              			},
              			{
              				"indexed": false,
              				"name": "value",
              				"type": "uint256"
              			},
              			{
              				"indexed": false,
              				"name": "betOnMiner",
              				"type": "address"
              			},
              			{
              				"indexed": false,
              				"name": "miner",
              				"type": "address"
              			},
              			{
              				"indexed": false,
              				"name": "balance",
              				"type": "uint256"
              			}
              		],
              		"name": "BetReceived",
              		"type": "event"
              	},
              	{
              		"anonymous": false,
              		"inputs": [
              			{
              				"indexed": false,
              				"name": "sender",
              				"type": "address"
              			},
              			{
              				"indexed": false,
              				"name": "value",
              				"type": "uint256"
              			},
              			{
              				"indexed": false,
              				"name": "rest",
              				"type": "uint256"
              			}
              		],
              		"name": "GivingBackTheRest",
              		"type": "event"
              	},
              	{
              		"anonymous": false,
              		"inputs": [
              			{
              				"indexed": false,
              				"name": "winner",
              				"type": "address"
              			}
              		],
              		"name": "Jackpot",
              		"type": "event"
              	},
              	{
              		"anonymous": false,
              		"inputs": [
              			{
              				"indexed": false,
              				"name": "value",
              				"type": "string"
              			}
              		],
              		"name": "LogStr",
              		"type": "event"
              	},
              	{
              		"anonymous": false,
              		"inputs": [
              			{
              				"indexed": false,
              				"name": "value",
              				"type": "uint256"
              			}
              		],
              		"name": "LogUint",
              		"type": "event"
              	},
              	{
              		"anonymous": false,
              		"inputs": [
              			{
              				"indexed": false,
              				"name": "value",
              				"type": "address"
              			}
              		],
              		"name": "LogAddress",
              		"type": "event"
              	}
              ];
                
                _this.contract.cls = _this.metamask.eth.contract(_this.contract.abi).at(_this.contract.addr);
                _this.loadBlockCountOptions(50, 7);
                _this.loadIntervalOptions(10, 5);
                _this.loadAccount();
                //_this.loadMiners();
                _this.animateLoading();
            },
            mounted: function() {
              /*$(function(){
                $('[data-toggle="tooltip"]').tooltip();
              });*/
            }
          });
        });
		</script>
	</body>
</html>