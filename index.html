<!doctype html>
<html>

<head>
    <meta http-equiv="cache-control" content="max-age=0" />
    <meta http-equiv="cache-control" content="no-cache" />
    <meta http-equiv="expires" content="0" />
    <meta http-equiv="expires" content="Tue, 01 Jan 1980 1:00:00 GMT" />
    <meta http-equiv="pragma" content="no-cache" />
    <title>TheNextBlock</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/bulma/0.6.2/css/bulma.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/alertifyjs@1.11.0/build/css/alertify.min.css" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/alertifyjs@1.11.0/build/css/themes/default.min.css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" type="text/css" />
    <script defer src="https://use.fontawesome.com/releases/v5.0.6/js/all.js"></script>

    <style>
        .pointer {
            cursor: pointer;
        }

        .text-center {
            text-align: center;
        }

        .lindicator {
            border-bottom: 2px solid #2962FF;
            width: 0%;
            opacity: 0.5;
            margin-bottom: 10px;
        }

        #github-icon {
            font-size: 35px;
            color: black;
        }

        #github-icon:hover {
            color: blue;
        }

        .center-table th {
            text-align: center;
            vertical-align: middle;
        }

        .center-table td {
            text-align: center;
            vertical-align: middle;
        }

        .tooltip {
            display: block !important;
            z-index: 10000;
        }

        .tooltip .tooltip-inner {
            background: black;
            color: white;
            border-radius: 16px;
            padding: 5px 10px 4px;
        }

        .tooltip .tooltip-arrow {
            width: 0;
            height: 0;
            border-style: solid;
            position: absolute;
            margin: 5px;
            border-color: black;
            z-index: 1;
        }

        .tooltip[x-placement^="top"] {
            margin-bottom: 5px;
        }

        .tooltip[x-placement^="top"] .tooltip-arrow {
            border-width: 5px 5px 0 5px;
            border-left-color: transparent !important;
            border-right-color: transparent !important;
            border-bottom-color: transparent !important;
            bottom: -5px;
            left: calc(50% - 5px);
            margin-top: 0;
            margin-bottom: 0;
        }

        .tooltip[x-placement^="bottom"] {
            margin-top: 5px;
        }

        .tooltip[x-placement^="bottom"] .tooltip-arrow {
            border-width: 0 5px 5px 5px;
            border-left-color: transparent !important;
            border-right-color: transparent !important;
            border-top-color: transparent !important;
            top: -5px;
            left: calc(50% - 5px);
            margin-top: 0;
            margin-bottom: 0;
        }

        .tooltip[x-placement^="right"] {
            margin-left: 5px;
        }

        .tooltip[x-placement^="right"] .tooltip-arrow {
            border-width: 5px 5px 5px 0;
            border-left-color: transparent !important;
            border-top-color: transparent !important;
            border-bottom-color: transparent !important;
            left: -5px;
            top: calc(50% - 5px);
            margin-left: 0;
            margin-right: 0;
        }

        .tooltip[x-placement^="left"] {
            margin-right: 5px;
        }

        .tooltip[x-placement^="left"] .tooltip-arrow {
            border-width: 5px 0 5px 5px;
            border-top-color: transparent !important;
            border-right-color: transparent !important;
            border-bottom-color: transparent !important;
            right: -5px;
            top: calc(50% - 5px);
            margin-left: 0;
            margin-right: 0;
        }

        .tooltip.popover .popover-inner {
            background: #f9f9f9;
            color: black;
            padding: 24px;
            border-radius: 5px;
            box-shadow: 0 5px 30px rgba(black, .1);
        }

        .tooltip.popover .popover-arrow {
            border-color: #f9f9f9;
        }

        .tooltip[aria-hidden='true'] {
            visibility: hidden;
            opacity: 0;
            transition: opacity .15s, visibility .15s;
        }

        .tooltip[aria-hidden='false'] {
            visibility: visible;
            opacity: 1;
            transition: opacity .15s;
        }
    </style>
</head>

<body>
    <div style="min-width: 1530px;" id="app">
        <nav class="navbar is-transparent is-fixed-top">
            <div class="navbar-brand">
                <h1 class="navbar-item"><b>TheNextBlock</b></h1>
            </div>

            <div class="navbar-menu">
                <div class="navbar-start">
                    <div class="navbar-item">
                        <a target="_blank" href="https://etherscan.io/">Smart Contract</a>
                    </div>
                    <div class="navbar-item">
                        <span><b>Total Prize Pool: {{player.pot}} ETH</b></span>
                    </div>
                    <div class="navbar-item">
                        <span><b>My Points: {{player.guessCount}}</b></span>
                    </div>
                </div>

                <div class="navbar-end" id="account" v-if="metamask.address.length">

                    <div class="navbar-item">
                        <button v-bind:disabled="(player.balance > 0) ? 'true' : ''" style="margin-left: 5px;" class="bd-tw-button button is-success">
                    <span class="icon">
                      <i class="fas fa-arrow-alt-circle-up"></i>
                    </span>
                    <span>
                      My Balance: {{player.balance}} ETH
                    </span>
                  </button>
                    </div>
                    <div class="navbar-item">
                        <span class="tag is-large"><b>Addr: 
                    <a target="_blank" v-bind:href="getEtherScanAddressLink(metamask.address)">
                      {{shortenStr(metamask.address)}}
                    </a> &nbsp; {{metamask.balance}} ETH
                   </b></span>
                    </div>
                </div>
            </div>
        </nav>
        <div class="container" style="margin-top: 70px;">
            <div v-if="showInfo" class="tile is-ancestor">
                <article class="message is-info">
                  <div class="message-header">
                    <p>Info</p>
                    <button class="delete" aria-label="delete" v-on:click="showInfo = false"></button>
                  </div>
                  <div class="message-body">
                    The Next Block 
<br>
The Next Block is a blockchain-based game in which users must predict which miner will mines  the transaction sent by players. 
<br>
<strong> Game Rules: </strong>
<br>
<ul>
   <li> Each account (public address) is able place only one bet per block. </li> 
    <li>If a player predicts the correct miner they will earn one point. </li>
    <li>If a player predicts (guesses) correctly in 5 consecutive bets and thus earns 5 points, hi is the winner and will receive 90% of the total pool (the bets collected). </li>

    <li>If the player does not correctly predict the miner, his/her points will be reduced to zero. </li>
    </ul>
    <strong>The total prize are collected from players' bets until one player correctly predicts 5 miners in a row. It is not necessary bet on  each block; it is up to you where to place your bets. </strong>


                  </div>
                </article>
            </div>
            <div class="tile is-ancestor">
                <div class="tile is-12">
                    <table class="table is-hoverable is-fullwidth center-table">
                        <thead>
                            <tr>
                                <th>Block #</th>
                                <th>Miner</th>
                                <th>
                                    <div class="select" v-tooltip.left="'Number of Blocks'">
                                        <select style="width: 80px; margin: 0 auto;" v-model="blockCount" v-on:change="loadBlocks()">
                                          <option v-for="bo in blockCountOptions">{{bo}}</option>
                                        </select>
                                    </div>
                                </th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="(block, index) in sortedBlocks">
                                <td>{{block.number}}</td>
                                <td>
                                    <a target="_blank" v-bind:href="getEtherScanAddressLink(block.miner+'#mine')"><b>{{block.miner}}</b></a>
                                    <span v-tooltip.bottom="'This miner mined ' + formatFloat((getMinersBlockCount(block.miner) * 100)/blockCount, 1) + '% percent of '+ blockCount +' blocks'" class="tag is-light"><b>{{getMinersBlockCount(block.miner)}} ({{formatFloat((getMinersBlockCount(block.miner) * 100)/blockCount, 2)}}%)</b></span>
                                    <span v-if="minerNames[block.miner]" class="tag is-link"><b>{{minerNames[block.miner]}}</b></span>
                                </td>
                                <td><a v-on:click="placeBet(block.miner)" class="button is-success" v-tooltip.bottom="'Bet that this miner will mine your transaction.'">BET</a></td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
    <script src="https://code.jquery.com/jquery-3.2.1.min.js" integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4=" crossorigin="anonymous"></script>
    <script src="https://cdn.jsdelivr.net/npm/alertifyjs@1.11.0/build/alertify.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/vue@2.5.13/dist/vue.js"></script>
    <script src="https://unpkg.com/v-tooltip"></script>
    <script type "text/javascript">
        /* global web3 */
        /* global Web3 */
        /* global Vue */
        /* global alertify */
        /* global $ */
        /* global Eth */
        var app;
        $(document).ready(function() {
            app = new Vue({
                el: '#app',
                data: {
                    bets: [],
                    showInfo: true,
                    filters: {

                    },
                    contract: {
                        addr: "0x6712F7e812499bfae13378eCfA7D27871AD406D2"
                    },
                    metamask: {
                        address: "",
                        balance: 0,
                        lastBlockNumber: 0
                    },
                    blocks: [],
                    minerNames: {
                        "0xea674fdde714fd979de3edf0f56aa9716b898ec8": "Ethermine",
                        "0x829bd824b016326a401d083b33d092293333a830": "f2pool_2",
                        "0x5a0b54d5dc17e0aadc383d2db43b0a0d3e029c4c": "ethfans.org_2",
                        "0xb2930b35844a230f00e51431acae96fe543a0347": "miningpoolhub_1",
                        "0x2a65aca4d5fc5b5c859090a6c34d164135398226": "DwarfPool1",
                        "0xf3b9d2c81f2b24b0fa0acaaa865b7d9ced5fc2fb": "bitclubpool",
                        "0x4bb96091ee9d802ed039c4d1a5f6216f90f81b01": "Ethpool_2",
                        "0x6a7a43be33ba930fe58f34e07d0ad6ba7adb9b1f": "Coinotron_2",
                        "0x9435d50503aee35c8757ae4933f7a0ab56597805": "waterhole"
                    },
                    blockCount: 0,
                    blockCountOptions: [],
                    player: {
                        balance: 0,
                        guessCount: 0,
                        pot: 0
                    }
                },
                computed: {
                    sortedBlocks: function() {
                        var _this = this;
                        return _this.blocks.sort(function(a, b) {
                            if (a.number < b.number) {
                                return 1;
                            }
                            if (a.number > b.number) {
                                return -1;
                            }
                            return 0;
                        });
                    }
                },
                methods: {
                    hasWeb3: function() {
                        return typeof web3 !== 'undefined' && web3.currentProvider;
                    },
                    hasMetamask: function() {
                        return web3.currentProvider.isMetaMask && web3.currentProvider.isConnected();
                    },
                    isMetaMaskLocked: function() {
                        return !this.metamask.web3.eth.accounts.length;
                    },
                    addBlock: function(err, block) {
                        var _this = this;
                        if (!err && block) {
                            _this.blocks.push(block);
                        }
                    },
                    loadBlocks: function(bc) {
                        var _this = this;
                        _this.blocks = [];
                        bc = bc || _this.blockCount;
                        _this.metamask.web3.eth.getBlockNumber(function(err, value) {
                            if (err) return;
                            _this.metamask.lastBlockNumber = value;
                            for (var i = 0; i < bc; i++)
                                _this.metamask.web3.eth.getBlock(value - i, _this.addBlock);
                        });
                    },
                    getMinersBlockCount: function(miner) {
                      var _this = this;
                      var count = 0;
                      _this.blocks.forEach(function(el){
                          if(el.miner == miner)
                            count++;
                      });
                      return count;
                    },
                    loadAccount: function() {
                        var _this = this;
                        _this.metamask.web3.eth.getAccounts(function(err, accounts) {
                            if (err) return;
                            _this.metamask.address = accounts[0];
                            _this.metamask.web3.eth.getBalance(_this.metamask.address, function(err, balance) {
                                if (!err)
                                    _this.metamask.balance = _this.formatFloat(_this.metamask.web3.fromWei(balance, 'ether').toFixed());
                            });
                        });
                    },
                    loadBlockCountOptions: function(factor, rep) {
                        var _this = this;
                        _this.blockCountOptions = [];
                        for (var i = 1; i <= rep; i++)
                            _this.blockCountOptions.push(i * factor);
                        _this.blockCount = _this.blockCountOptions[0];
                    },
                    loadContractData: function() {
                        var _this = this;
                        _this.contract.cls.getPot(function(err, val) {
                            if (!err) _this.player.pot = _this.formatFloat(_this.metamask.web3.fromWei(val, 'ether'));
                        });
                        _this.contract.cls.getMyBalance(function(err, val) {
                            if (!err) _this.player.balance = val.toString();
                        });
                        _this.contract.cls.getMyGuessCount(function(err, val) {
                            if (!err) _this.player.guessCount = val.toString();
                        });
                        _this.contract.cls.allowedBetAmount(function(err, val) {
                            if (!err) _this.player.allowedBetAmount = val.toString();
                        });
                    },
                    placeBet: function(miner) {
                        var _this = this;
                        _this.contract.cls.placeBet(miner, {
                            from: _this.metamask.web3.eth.accounts[0],
                            value: _this.player.allowedBetAmount,
                            gas: 4000000,
                            gasPrice: 35000000000
                        }, console.log);
                    },
                    formatFloat: function(number, factor) {
                        //return parseFloat(Math.round(number * 100) / 100).toFixed(5);
                        return parseFloat(number).toFixed(factor || 5);
                    },
                    getEtherScanAddressLink: function(address) {
                        return "https://etherscan.io/address/{{address}}".replace('{{address}}', address);
                    },
                    getEtherScanBlockLink: function(blockNumber) {
                        return "https://etherscan.io/block/{{blockNumber}}".replace('{{blockNumber}}', blockNumber);
                    },
                    shortenStr: function(str = "", topBottomRem = 5) {
                        return str.substr(0, topBottomRem) + '...' + str.substr(str.length - topBottomRem, topBottomRem);
                    },
                    onNewBlockMined: function(err, result) {
                        var _this = this;
                        _this.loadBlocks();
                        _this.loadAccount();
                        _this.loadContractData();
                        if (err) {
                            alertify.error(err);
                        } else {
                            _this.metamask.web3.eth.getBlock(result, function(err, block) {
                                if (!err)
                                    alertify.success("New Block Arrived: " + block.number);
                            });
                        }
                    },
                    onBetReceived: function(err, result) {
                        var _this = this;
                        console.log(result);
                        if (!err)
                            _this.bets.push({
                                miner: result.args.miner,
                                sender: result.args.sender,
                                betOnMiner: result.args.betOnMiner,
                                blockNumber: result.blockNumber
                            });

                    }
                },
                created: function() {
                    var _this = this;
                    if (!_this.metamask.web3) {
                        _this.metamask.web3 = new Web3(web3.currentProvider);
                    }
                    if (!_this.hasWeb3()) {
                        alertify.alert("Metamask Extension is not installed.", function() {
                            alertify.error('Install Metamask Extension.');
                        });
                        return;
                    }
                    if (!_this.hasMetamask()) {
                        alertify.alert("Your metamask is not connected.", function() {});
                        return;
                    }
                    if (_this.isMetaMaskLocked()) {
                        alertify.alert("Metamask is locked.", function() {
                            alertify.error('Unlock metamask.');
                        });
                        return;
                    }

                    _this.contract.abi = [{
                            "constant": true,
                            "inputs": [],
                            "name": "getBalance",
                            "outputs": [{
                                "name": "",
                                "type": "uint256"
                            }],
                            "payable": false,
                            "stateMutability": "view",
                            "type": "function"
                        },
                        {
                            "constant": false,
                            "inputs": [{
                                "name": "_miner",
                                "type": "address"
                            }],
                            "name": "placeBet",
                            "outputs": [],
                            "payable": true,
                            "stateMutability": "payable",
                            "type": "function"
                        },
                        {
                            "constant": true,
                            "inputs": [],
                            "name": "isBetEnabled",
                            "outputs": [{
                                "name": "",
                                "type": "bool"
                            }],
                            "payable": false,
                            "stateMutability": "view",
                            "type": "function"
                        },
                        {
                            "constant": true,
                            "inputs": [],
                            "name": "getPot",
                            "outputs": [{
                                "name": "",
                                "type": "uint256"
                            }],
                            "payable": false,
                            "stateMutability": "view",
                            "type": "function"
                        },
                        {
                            "constant": false,
                            "inputs": [],
                            "name": "withdrawMyFunds",
                            "outputs": [],
                            "payable": false,
                            "stateMutability": "nonpayable",
                            "type": "function"
                        },
                        {
                            "constant": true,
                            "inputs": [],
                            "name": "getMyBalance",
                            "outputs": [{
                                "name": "",
                                "type": "uint256"
                            }],
                            "payable": false,
                            "stateMutability": "view",
                            "type": "function"
                        },
                        {
                            "constant": false,
                            "inputs": [],
                            "name": "withdrawOwnersFunds",
                            "outputs": [],
                            "payable": false,
                            "stateMutability": "nonpayable",
                            "type": "function"
                        },
                        {
                            "constant": true,
                            "inputs": [],
                            "name": "allowedBetAmount",
                            "outputs": [{
                                "name": "",
                                "type": "uint256"
                            }],
                            "payable": false,
                            "stateMutability": "view",
                            "type": "function"
                        },
                        {
                            "constant": true,
                            "inputs": [],
                            "name": "getMyGuessCount",
                            "outputs": [{
                                "name": "",
                                "type": "uint8"
                            }],
                            "payable": false,
                            "stateMutability": "view",
                            "type": "function"
                        },
                        {
                            "constant": true,
                            "inputs": [{
                                "name": "playerAddr",
                                "type": "address"
                            }],
                            "name": "getPlayersGuessCount",
                            "outputs": [{
                                "name": "",
                                "type": "uint8"
                            }],
                            "payable": false,
                            "stateMutability": "view",
                            "type": "function"
                        },
                        {
                            "constant": true,
                            "inputs": [{
                                "name": "playerAddr",
                                "type": "address"
                            }],
                            "name": "getPlayersWonBlocks",
                            "outputs": [{
                                "name": "",
                                "type": "uint256[]"
                            }],
                            "payable": false,
                            "stateMutability": "view",
                            "type": "function"
                        },
                        {
                            "constant": true,
                            "inputs": [],
                            "name": "requiredGuessCount",
                            "outputs": [{
                                "name": "",
                                "type": "uint8"
                            }],
                            "payable": false,
                            "stateMutability": "view",
                            "type": "function"
                        },
                        {
                            "constant": true,
                            "inputs": [],
                            "name": "jackpotPercent",
                            "outputs": [{
                                "name": "",
                                "type": "uint8"
                            }],
                            "payable": false,
                            "stateMutability": "view",
                            "type": "function"
                        },
                        {
                            "constant": true,
                            "inputs": [],
                            "name": "ownerProfitPercent",
                            "outputs": [{
                                "name": "",
                                "type": "uint8"
                            }],
                            "payable": false,
                            "stateMutability": "view",
                            "type": "function"
                        },
                        {
                            "constant": true,
                            "inputs": [],
                            "name": "getMyWonBlocks",
                            "outputs": [{
                                "name": "",
                                "type": "uint256[]"
                            }],
                            "payable": false,
                            "stateMutability": "view",
                            "type": "function"
                        },
                        {
                            "constant": true,
                            "inputs": [{
                                "name": "playerAddr",
                                "type": "address"
                            }],
                            "name": "getPlayersBalance",
                            "outputs": [{
                                "name": "",
                                "type": "uint256"
                            }],
                            "payable": false,
                            "stateMutability": "view",
                            "type": "function"
                        },
                        {
                            "constant": true,
                            "inputs": [],
                            "name": "getOwnersBalance",
                            "outputs": [{
                                "name": "",
                                "type": "uint256"
                            }],
                            "payable": false,
                            "stateMutability": "view",
                            "type": "function"
                        },
                        {
                            "inputs": [],
                            "payable": false,
                            "stateMutability": "nonpayable",
                            "type": "constructor"
                        },
                        {
                            "payable": true,
                            "stateMutability": "payable",
                            "type": "fallback"
                        },
                        {
                            "anonymous": false,
                            "inputs": [{
                                    "indexed": false,
                                    "name": "sender",
                                    "type": "address"
                                },
                                {
                                    "indexed": false,
                                    "name": "value",
                                    "type": "uint256"
                                },
                                {
                                    "indexed": false,
                                    "name": "betOnMiner",
                                    "type": "address"
                                },
                                {
                                    "indexed": false,
                                    "name": "miner",
                                    "type": "address"
                                },
                                {
                                    "indexed": false,
                                    "name": "balance",
                                    "type": "uint256"
                                }
                            ],
                            "name": "BetReceived",
                            "type": "event"
                        },
                        {
                            "anonymous": false,
                            "inputs": [{
                                    "indexed": false,
                                    "name": "sender",
                                    "type": "address"
                                },
                                {
                                    "indexed": false,
                                    "name": "value",
                                    "type": "uint256"
                                },
                                {
                                    "indexed": false,
                                    "name": "rest",
                                    "type": "uint256"
                                }
                            ],
                            "name": "GivingBackTheRest",
                            "type": "event"
                        },
                        {
                            "anonymous": false,
                            "inputs": [{
                                "indexed": false,
                                "name": "winner",
                                "type": "address"
                            }],
                            "name": "Jackpot",
                            "type": "event"
                        },
                        {
                            "anonymous": false,
                            "inputs": [{
                                "indexed": false,
                                "name": "value",
                                "type": "string"
                            }],
                            "name": "LogStr",
                            "type": "event"
                        },
                        {
                            "anonymous": false,
                            "inputs": [{
                                "indexed": false,
                                "name": "value",
                                "type": "uint256"
                            }],
                            "name": "LogUint",
                            "type": "event"
                        },
                        {
                            "anonymous": false,
                            "inputs": [{
                                "indexed": false,
                                "name": "value",
                                "type": "address"
                            }],
                            "name": "LogAddress",
                            "type": "event"
                        }
                    ];

                    _this.contract.cls = _this.metamask.web3.eth.contract(_this.contract.abi).at(_this.contract.addr);
                    _this.loadBlockCountOptions(10, 5);
                    _this.loadAccount();
                    _this.loadBlocks();
                    _this.loadContractData();
                    _this.filters.blockMined = _this.metamask.web3.eth.filter('latest');
                    _this.filters.blockMined.watch(_this.onNewBlockMined);
                    _this.filters.betReceived = _this.contract.cls.BetReceived();
                    _this.filters.betReceived.watch(_this.onBetReceived);
                }
            });
        });
    </script>
    

</body>

</html>